---
AWSTemplateFormatVersion: 2010-09-09
Description: AWS S3 resources for Givesource(R)
Parameters:

  AdminPagesCNAMEs:
    Type: CommaDelimitedList

  AdminPagesSSLCertificateArn:
    Type: String

  PublicPagesCNAMEs:
    Type: CommaDelimitedList

  PublicPagesSSLCertificateArn:
    Type: String

# todo remove when headers are moved back to vpc.yml
  ApiDistributionUrl:
    Type: String

  RestApi:
    Type: String

Conditions:

  HasAdminPagesCNAMEs: !Not [!Equals ["", !Join ["", !Ref AdminPagesCNAMEs ] ] ]

  HasAdminPagesSSLCertificateArn: !Not [!Equals ["", !Ref AdminPagesSSLCertificateArn]]

  HasPublicPagesCNAMEs: !Not [!Equals ["", !Join ["", !Ref PublicPagesCNAMEs ] ] ]

  HasPublicPagesSSLCertificateArn: !Not [!Equals ["", !Ref PublicPagesSSLCertificateArn]]

Resources:

  # AWS S3 Resources

  AdminPagesS3:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      WebsiteConfiguration:
        IndexDocument: index.html

  AdminPagesS3BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref AdminPagesS3
      PolicyDocument:
        Statement:
        - Sid: allow-ssl-requests-only
          Effect: Deny
          Principal: "*"
          Action: s3:*
          Resource: !Sub arn:aws:s3:::${AdminPagesS3}/*
          Condition:
            Bool:
              aws:SecureTransport: false
        - Sid: allow-cloudfront-access
          Effect: Allow
          Principal:
            CanonicalUser: !GetAtt CloudFrontOAI.S3CanonicalUserId
          Action: s3:Get*
          Resource: !Sub arn:aws:s3:::${AdminPagesS3}/*

  PublicPagesS3:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      WebsiteConfiguration:
        IndexDocument: index.html

  PublicPagesS3BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref PublicPagesS3
      PolicyDocument:
        Statement:
        - Sid: allow-ssl-requests-only
          Effect: Deny
          Principal: "*"
          Action: s3:*
          Resource: !Sub arn:aws:s3:::${PublicPagesS3}/*
          Condition:
            Bool:
              aws:SecureTransport: false
        - Sid: allow-cloudfront-access
          Effect: Allow
          Principal:
            CanonicalUser: !GetAtt CloudFrontOAI.S3CanonicalUserId
          Action: s3:Get*
          Resource: !Sub arn:aws:s3:::${PublicPagesS3}/*

  UploadsS3:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      CorsConfiguration:
        CorsRules:
          - AllowedMethods:
              - GET
              - PUT
              - DELETE
            AllowedOrigins:
              - "*"
            AllowedHeaders:
              - "*"
            MaxAge: 3600
      WebsiteConfiguration:
        IndexDocument: index.html

  UploadsS3BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref UploadsS3
      PolicyDocument:
        Statement:
        - Sid: allow-ssl-requests-only
          Effect: Deny
          Principal: "*"
          Action: s3:*
          Resource: !Sub arn:aws:s3:::${UploadsS3}/*
          Condition:
            Bool:
              aws:SecureTransport: false
        - Sid: allow-cloudfront-access
          Effect: Allow
          Principal:
            CanonicalUser: !GetAtt CloudFrontOAI.S3CanonicalUserId
          Action: s3:Get*
          Resource: !Sub arn:aws:s3:::${UploadsS3}/*

  Reports:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LoggingConfiguration:
        DestinationBucketName: !ImportValue AccessLoggingBucket
        LogFilePrefix: !Sub reports-${AWS::StackName}/

  ReportsBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref Reports
      PolicyDocument:
        Statement:
        - Sid: allow-ssl-requests-only
          Effect: Deny
          Principal: '*'
          Action: s3:*
          Resource: !Sub arn:aws:s3:::${Reports}/*
          Condition:
            Bool:
              aws:SecureTransport: false

  GivesourceCache:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      CorsConfiguration:
        CorsRules:
          - AllowedMethods:
              - GET
              - PUT
              - DELETE
            AllowedOrigins:
              - "*"
            AllowedHeaders:
              - "*"
      WebsiteConfiguration:
        IndexDocument: index.html

  GivesourceCacheBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref GivesourceCache
      PolicyDocument:
        Statement:
        - Sid: allow-ssl-requests-only
          Effect: Deny
          Principal: "*"
          Action: s3:*
          Resource: !Sub arn:aws:s3:::${GivesourceCache}/*
          Condition:
            Bool:
              aws:SecureTransport: false
        - Sid: allow-cloudfront-access
          Effect: Allow
          Principal:
            CanonicalUser: !GetAtt CloudFrontOAI.S3CanonicalUserId
          Action: s3:Get*
          Resource: !Sub arn:aws:s3:::${GivesourceCache}/*

  # AWS CloudFront Resources

  longLivedCachingHeaderPolicy:
    Type: AWS::CloudFront::ResponseHeadersPolicy
    Properties:
      ResponseHeadersPolicyConfig:
        Name: CustomLongLivedCachingHeadersPolicyMK
        SecurityHeadersConfig:
          ContentSecurityPolicy:
            ContentSecurityPolicy: !Sub >-
              default-src 'none';
              base-uri 'none';
              img-src 'self';
              script-src 'none';
              font-src 'self';
              form-action 'none';
              frame-ancestors 'none';
              style-src 'self';
              object-src 'none';
            Override: false
          ContentTypeOptions:
            Override: false
          FrameOptions:
            FrameOption: DENY
            Override: false
          ReferrerPolicy:
            ReferrerPolicy: same-origin
            Override: false
          StrictTransportSecurity:
            AccessControlMaxAgeSec: 63072000
            IncludeSubdomains: true
            Preload: true
            Override: false
          XSSProtection:
            ModeBlock: true
            Protection: true
            Override: false
        CustomHeadersConfig:
          Items:
            - Header: Cache-Control
              Value: max-age=31536000
              Override: false

  mediumCachingHeaderPolicy:
    Type: AWS::CloudFront::ResponseHeadersPolicy
    Properties:
      ResponseHeadersPolicyConfig:
        Name: CustomMediumLivedCachingHeadersPolicyMK
        SecurityHeadersConfig:
          ContentSecurityPolicy:
            ContentSecurityPolicy: !Sub >-
              default-src 'none';
              base-uri 'none';
              img-src 'self';
              script-src 'none';
              font-src 'self';
              form-action 'none';
              frame-ancestors 'none';
              style-src 'self';
              object-src 'none';
            Override: false
          ContentTypeOptions:
            Override: false
          FrameOptions:
            FrameOption: DENY
            Override: false
          ReferrerPolicy:
            ReferrerPolicy: same-origin
            Override: false
          StrictTransportSecurity:
            AccessControlMaxAgeSec: 63072000
            IncludeSubdomains: true
            Preload: true
            Override: false
          XSSProtection:
            ModeBlock: true
            Protection: true
            Override: false
        CustomHeadersConfig:
          Items:
            - Header: Cache-Control
              Value: max-age=600
              Override: false

  shortLivedCachingHeaderPolicy:
    Type: AWS::CloudFront::ResponseHeadersPolicy
    Properties:
      ResponseHeadersPolicyConfig:
        Name: CustomShortLivedCachingHeadersPolicyMK
        SecurityHeadersConfig:
          ContentSecurityPolicy:
            # ApiDistributionUrl=https://d158eotjr9ldbh.cloudfront.net/
            # https://6isqknpo1j.execute-api.us-east-1.amazonaws.com
            # https://cognito-idp.us-east-1.amazonaws.com
            # UploadsS3...=https://mk-test-stack-s3stack-1qd65t2hgj2vn-uploadss3-1cr2gv3kmu7f7.s3.us-east-1.amazonaws.com
            # UploadsS3...Region...=https://mk-test-stack-s3stack-1qd65t2hgj2vn-uploadss3-1cr2gv3kmu7f7.s3.amazonaws.com
            # img-src https://d17qtxd9bgwc9f.cloudfront.net

            # connect-src 'self' ${ApiDistributionUrl} https://${RestApi}.execute-api.${AWS::Region}.amazonaws.com https://cognito-idp.${AWS::Region}.amazonaws.com https://api.paymentspring.com
            #              https://${UploadsS3}.s3.${AWS::Region}.amazonaws.com https://${UploadsS3}.s3.amazonaws.com https://vimeo.com;
            # img-src 'self' data: www.google-analytics.com https://${UploadsDistribution.DomainName}

            ContentSecurityPolicy: !Sub >-
              default-src 'none';
              base-uri 'none';
              connect-src 'self' https://*.cloudfront.net https://*.amazonaws.com https://api.paymentspring.com https://vimeo.com
              https://www.google-analytics.com;
              font-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com https://use.fontawesome.com;
              form-action 'self';
              frame-ancestors 'self';
              frame-src 'self' https://www.youtube.com https://player.vimeo.com;
              img-src 'self' data: www.google-analytics.com https://*.cloudfront.net
              https://www.gravatar.com https://img.youtube.com https://i.vimeocdn.com https://cdnjs.cloudflare.com;
              script-src 'self' 'unsafe-inline' https://www.google-analytics.com https://fonts.googleapis.com https://use.fontawesome.com https://cdnjs.cloudflare.com
              https://www.google.com/recaptcha/api.js https://www.gstatic.com/recaptcha/ https://www.googletagmanager.com/gtag/js;
              style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://use.fontawesome.com https://cdnjs.cloudflare.com;
              object-src 'none'
            Override: false
          ContentTypeOptions:
            Override: false
          FrameOptions:
            FrameOption: DENY
            Override: false
          ReferrerPolicy:
            ReferrerPolicy: same-origin
            Override: false
          StrictTransportSecurity:
            AccessControlMaxAgeSec: 63072000
            IncludeSubdomains: true
            Preload: true
            Override: false
          XSSProtection:
            ModeBlock: true
            Protection: true
            Override: false
        CustomHeadersConfig:
          Items:
            - Header: Cache-Control
              Value: no-cache
              Override: true

  AdminPagesDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Aliases: !If [HasAdminPagesCNAMEs, !Ref AdminPagesCNAMEs, !Ref "AWS::NoValue"]
        Origins:
          - DomainName: !GetAtt AdminPagesS3.DomainName
            Id: !Ref AdminPagesS3
            S3OriginConfig:
              OriginAccessIdentity: !Join ['', ['origin-access-identity/cloudfront/', !Ref CloudFrontOAI]]
        Enabled: true
        Comment: Distribution for Givsource admin pages S3 bucket
        DefaultRootObject: index.html
        DefaultCacheBehavior:
          DefaultTTL: 0
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none
          TargetOriginId: !Ref AdminPagesS3
          MaxTTL: 86400
          MinTTL: 0
          Compress: true
          ViewerProtocolPolicy: redirect-to-https
          ResponseHeadersPolicyId: !GetAtt shortLivedCachingHeaderPolicy.Id
        PriceClass: PriceClass_200
        ViewerCertificate:
          AcmCertificateArn: !If [HasAdminPagesSSLCertificateArn, !Ref AdminPagesSSLCertificateArn, !Ref "AWS::NoValue"]
          CloudFrontDefaultCertificate: !If [HasAdminPagesSSLCertificateArn, !Ref "AWS::NoValue", true]
          MinimumProtocolVersion: !If [HasAdminPagesSSLCertificateArn, "TLSv1.1_2016", !Ref "AWS::NoValue"]
          SslSupportMethod: !If [HasAdminPagesSSLCertificateArn, "sni-only", !Ref "AWS::NoValue"]
        CustomErrorResponses:
          - ErrorCachingMinTTL: 0
            ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html
          - ErrorCachingMinTTL: 0
            ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
    DependsOn: AdminPagesS3

  PublicPagesDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Aliases: !If [HasPublicPagesCNAMEs, !Ref PublicPagesCNAMEs, !Ref "AWS::NoValue"]
        Origins:
        - Id: !Ref PublicPagesS3
          DomainName: !GetAtt PublicPagesS3.DomainName
          S3OriginConfig:
            OriginAccessIdentity: !Join ['', ['origin-access-identity/cloudfront/', !Ref CloudFrontOAI]]
        Enabled: true
        Comment: Distribution for Givesource(R) public pages S3 bucket
        DefaultRootObject: index.html
        DefaultCacheBehavior:
          DefaultTTL: 0
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none
            Headers:
              - User-Agent
          TargetOriginId: !Ref PublicPagesS3
          MaxTTL: 86400
          MinTTL: 0
          Compress: true
          ViewerProtocolPolicy: redirect-to-https
#          ResponseHeadersPolicyId: !ImportValue global-short-lived-caching-header-policy
          ResponseHeadersPolicyId: !GetAtt shortLivedCachingHeaderPolicy.Id
        CacheBehaviors:
          - PathPattern: assets/*
            DefaultTTL: 31536000 # 365 days
            Compress: true
            ViewerProtocolPolicy: redirect-to-https
            TargetOriginId: !Ref PublicPagesS3
#            ResponseHeadersPolicyId: !ImportValue global-long-lived-caching-header-policy
            ResponseHeadersPolicyId: !GetAtt longLivedCachingHeaderPolicy.Id
            ForwardedValues:
              QueryString: false
        PriceClass: PriceClass_200
        ViewerCertificate:
          AcmCertificateArn: !If [HasPublicPagesSSLCertificateArn, !Ref PublicPagesSSLCertificateArn, !Ref "AWS::NoValue"]
          CloudFrontDefaultCertificate: !If [HasPublicPagesSSLCertificateArn, !Ref "AWS::NoValue", true]
          MinimumProtocolVersion: !If [HasPublicPagesSSLCertificateArn, "TLSv1.1_2016", !Ref "AWS::NoValue"]
          SslSupportMethod: !If [HasPublicPagesSSLCertificateArn, "sni-only", !Ref "AWS::NoValue"]
        CustomErrorResponses:
          - ErrorCachingMinTTL: 0
            ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html
          - ErrorCachingMinTTL: 0
            ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
    DependsOn: PublicPagesS3

  UploadsDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Origins:
        - DomainName: !GetAtt UploadsS3.DomainName
          Id: !Ref UploadsS3
          S3OriginConfig:
            OriginAccessIdentity: !Join ['', ['origin-access-identity/cloudfront/', !Ref CloudFrontOAI]]
        Enabled: true
        Comment: Distribution for Givesource(R) uploads S3 bucket
        DefaultRootObject: index.html
        DefaultCacheBehavior:
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none
          TargetOriginId: !Ref UploadsS3
          DefaultTTL: 600
          MaxTTL: 86400
          MinTTL: 0
          Compress: true
#          ResponseHeadersPolicyId: !ImportValue global-medium-caching-header-policy
          ResponseHeadersPolicyId: !GetAtt mediumCachingHeaderPolicy.Id
          ViewerProtocolPolicy: allow-all
        PriceClass: PriceClass_200
        ViewerCertificate:
          CloudFrontDefaultCertificate: true
        CustomErrorResponses:
          - ErrorCachingMinTTL: 0
            ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html
          - ErrorCachingMinTTL: 0
            ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
    DependsOn: UploadsS3

  CloudFrontOAI:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: !Ref UploadsS3

  CachingDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Origins:
        - DomainName: !GetAtt GivesourceCache.DomainName
          Id: !Ref GivesourceCache
          S3OriginConfig:
            OriginAccessIdentity: !Join ['', ['origin-access-identity/cloudfront/', !Ref CloudFrontOAI]]
        Enabled: true
        Comment: Distribution for Givesource(R) caching S3 bucket
        DefaultRootObject: index.html
        DefaultCacheBehavior:
          DefaultTTL: 0
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none
          TargetOriginId: !Ref GivesourceCache
          MaxTTL: 86400
          MinTTL: 0
          Compress: true
          ViewerProtocolPolicy: allow-all
        PriceClass: PriceClass_200
        ViewerCertificate:
          CloudFrontDefaultCertificate: true
        CustomErrorResponses:
          - ErrorCachingMinTTL: 0
            ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html
    DependsOn: GivesourceCache


Outputs:

  AdminPagesCloudFrontDistribution:
    Value: !Ref AdminPagesDistribution

  AdminPagesCloudFrontDomainName:
    Value: !GetAtt AdminPagesDistribution.DomainName

  AdminPagesCloudFrontUrl:
    Value: !Sub |-
      https://${AdminPagesDistribution.DomainName}

  AdminPagesS3:
    Value: !Ref AdminPagesS3

  AdminPagesS3BucketUrl:
    Value: !GetAtt AdminPagesS3.WebsiteURL

  PublicPagesCloudFrontDistribution:
    Value: !Ref PublicPagesDistribution

  PublicPagesCloudFrontDomainName:
    Value: !GetAtt PublicPagesDistribution.DomainName

  PublicPagesCloudFrontUrl:
    Value: !Sub |-
      https://${PublicPagesDistribution.DomainName}

  PublicPagesS3:
    Value: !Ref PublicPagesS3

  PublicPagesS3BucketUrl:
    Value: !GetAtt PublicPagesS3.WebsiteURL

  UploadsCloudFrontDistribution:
    Value: !Ref UploadsDistribution

  UploadsCloudFrontDomainName:
    Value: !GetAtt UploadsDistribution.DomainName

  UploadsCloudFrontUrl:
    Value: !Sub |-
      https://${UploadsDistribution.DomainName}

  UploadsS3:
    Value: !Ref UploadsS3

  UploadsS3BucketUrl:
    Value: !GetAtt UploadsS3.WebsiteURL

  CachingCloudFrontDistribution:
    Value: !Ref CachingDistribution

  CachingCloudFrontDomainName:
    Value: !GetAtt CachingDistribution.DomainName

  CachingCloudFrontUrl:
    Value: !Sub |-
      https://${CachingDistribution.DomainName}

  GivesourceCache:
    Value: !Ref GivesourceCache

  GivesourceCacheBucketUrl:
    Value: !GetAtt GivesourceCache.WebsiteURL

  Reports:
    Value: !Ref Reports

  ReportsBucketUrl:
    Value: !GetAtt Reports.WebsiteURL
